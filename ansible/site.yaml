---
- name: Prepare all nodes & Download RKE2
  hosts: rke2 # servers + agents + longhorn nodes combined
  gather_facts: true
  roles:
    - download_rke2

# Bootstrap k8s
- name: Bootstrap RKE2 Servers
  hosts: servers
  gather_facts: true
  roles:
    - add_server

- name: Add additional RKE2 agents & longhorn agents
  hosts: agents, longhorn
  gather_facts: true
  roles:
    - add_agent

# Deploy applications
- name: Deploy applications
  hosts: servers
  gather_facts: true
  run_once: true
  roles:
    - role: apply_kube_vip
    - role: deploy_helm_apps

# Configure Vault Kubernetes Auth
- name: Export Kubernetes credentials for Vault
  hosts: servers[0]
  gather_facts: false
  tasks:
    - name: Get Kubernetes CA certificate
      ansible.builtin.command:
        cmd: kubectl config view --raw --minify --flatten -o jsonpath='{.clusters[0].cluster.certificate-authority-data}'
      environment:
        KUBECONFIG: /etc/rancher/rke2/rke2.yaml
      register: k8s_ca_cert_b64
      changed_when: false

    - name: Decode and save Kubernetes CA certificate locally
      ansible.builtin.copy:
        content: "{{ k8s_ca_cert_b64.stdout | b64decode }}"
        dest: "{{ playbook_dir }}/k8s-ca.crt"
        mode: "0644"
      delegate_to: localhost

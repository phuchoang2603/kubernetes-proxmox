- name: Load k8s nodes from environment variable
  set_fact:
    k8s_nodes: "{{ lookup('env', 'TF_VAR_k8s_nodes') | from_json }}"

- name: Load longhorn nodes from environment variable
  set_fact:
    longhorn_nodes: "{{ lookup('env', 'TF_VAR_longhorn_nodes') | from_json }}"
  tags: longhorn

- name: Ensure inventory directories exist
  ansible.builtin.file:
    path: "./inventory/group_vars"
    state: directory
    mode: "0755"

- name: Render inventory (always includes servers and agents, longhorn if --tags longhorn)
  ansible.builtin.template:
    src: templates/hosts.ini.j2
    dest: "./inventory/hosts.ini"
    mode: "0644"

- name: Render group_vars/all.yaml from environment
  ansible.builtin.template:
    src: templates/all.yaml.j2
    dest: "./inventory/group_vars/all.yaml"
    mode: "0644"
